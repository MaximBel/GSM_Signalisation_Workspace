/*
 * io.c
 *
 *  Created on: 13 θών. 2018 γ.
 *      Author: Max
 */

#include "FreeRTOS.h"
#include "task.h"
#include "io.h"
#include "main.h"
#include "stm32f1xx_hal.h"

#define BUZZER_PERIOD_ACTIVE 700

#define BUZZER_PERIOD_PASSIVE 500

#define BUTTON_UPDATE_COUNT 200

typedef enum {
	BuzzerPhase_Active,
	BuzzerPhase_Passive
} BuzzerPhase_t;


static BuzzerPhase_t buzzer_phase = BuzzerPhase_Passive;

static io_handlers_t io_handlers;

static Buzzer_state_t buzzer_state = Buzzer_Off;


static void io_handler(void *pvParameters);

static void buzzer_run(void);

static button_run(void);


uint8_t io_init(io_handlers_t *handlers) {

	if(handlers->ButtonHandler == NULL ||
			handlers->DoorHandler == NULL) {

		return 1;

	}

	memcpy(&io_handlers, handlers, sizeof(io_handlers_t));

	xTaskCreate(io_handler, "IO handler", configMINIMAL_STACK_SIZE * 5, NULL, 1, NULL);

}

void ToggleBuzzer(Buzzer_state_t newState);

void SetSSI(uint8_t seg1, uint8_t seg2, uint8_t seg3, uint8_t dots);





static void io_handler(void *pvParameters) {

	while(1) {

		buzzer_run();


	}


}

static void buzzer_run(void) {
	static uint32_t next_phase_change = 0;

	if (buzzer_state == Buzzer_Pulse && xTaskGetTickCount() > next_phase_change) {

		switch (buzzer_phase) {

		case BuzzerPhase_Active:

			next_phase_change = xTaskGetTickCount() + BUZZER_PERIOD_ACTIVE;

			HAL_GPIO_WritePin(buzzer_GPIO_Port, buzzer_Pin, GPIO_PIN_SET);

			buzzer_phase = BuzzerPhase_Passive;

			break;

		case BuzzerPhase_Passive:

			next_phase_change = xTaskGetTickCount() + BUZZER_PERIOD_PASSIVE;

			HAL_GPIO_WritePin(buzzer_GPIO_Port, buzzer_Pin, GPIO_PIN_RESET);

			buzzer_phase = BuzzerPhase_Active;

			break;

		default:

			next_phase_change = xTaskGetTickCount() + BUZZER_PERIOD_PASSIVE;

			HAL_GPIO_WritePin(buzzer_GPIO_Port, buzzer_Pin, GPIO_PIN_RESET);

			buzzer_phase = BuzzerPhase_Active;

		}

	} else {

		HAL_GPIO_WritePin(buzzer_GPIO_Port, buzzer_Pin, GPIO_PIN_RESET);

	}

}

static button_run(void) {
	static uint8_t checkCount[4] = { 0, 0, 0, 0 };;
	static uint8_t updateCounter = 0;

	if(updateCounter < BUTTON_UPDATE_COUNT) {

		checkCount[0] += (HAL_GPIO_ReadPin(button_GPIO_Port, button_Pin) != 0) ? 1 : 0;

		checkCount[1] += (HAL_GPIO_ReadPin(buttonA7_GPIO_Port, buttonA7_Pin) != 0) ? 1 : 0;

		checkCount[2] += (HAL_GPIO_ReadPin(buttonB0_GPIO_Port, buttonB0_Pin) != 0) ? 1 : 0;

		checkCount[3] += (HAL_GPIO_ReadPin(buttonB1_GPIO_Port, buttonB1_Pin) != 0) ? 1 : 0;

	} else {



	}



}
